testjob:
  only:
    - master
    - dev
  script:
    # !!kill coverage in case of hanging processes
    - if pgrep coverage; then pkill -f coverage; fi
    # set env
    - export PYTHONPATH="/home/wenqi/.local/lib/python2.7/site-packages":$PYTHONPATH
    - export PATH="/home/wenqi/.local/bin":$PATH

    # print system info
    - which nvidia-smi
    - nvidia-smi
    - pwd
    - python -c "import tensorflow as tf; print tf.__version__"
    - python -c "import tensorflow as tf; from tensorflow.python.client import device_lib; print device_lib.list_local_devices()"
    - ls -la /dev | grep nvidia

    - echo $(python testing/get_gpu_index.py)
    - export CUDA_VISIBLE_DEVICES=$(python testing/get_gpu_index.py)

    # download data
    - wget -q https://www.dropbox.com/s/y7mdh4m9ptkibax/example_volumes.tar.gz
    - tar -xzvf example_volumes.tar.gz
    - wget -q https://www.dropbox.com/s/94wa4fl8f8k3aie/testing_data.tar.gz
    - tar -xzvf testing_data.tar.gz

    # run python code with coverage wrapper
    - coverage erase

    - coverage run -a --source . run_application.py train -c config/highres3dnet_config.txt --batch_size 1 --image_size 32 --label_size 32 --queue_length 5 --num_threads 2
    - coverage run -a --source . run_application.py inference -c config/highres3dnet_config.txt --batch_size 8 --image_size 64 --label_size 64 --queue_length 32

    - coverage run -a --source . run_application.py train -c config/scalenet_config.txt --batch_size 1 --image_size 32 --label_size 32 --queue_length 5 --num_threads 2
    - coverage run -a --source . run_application.py inference -c config/scalenet_config.txt --batch_size 16 --image_size 64 --label_size 64 --queue_length 32

    - coverage run -a --source . run_application.py train -c config/vnet_config.txt --batch_size 1 --image_size 32 --label_size 32 --queue_length 5 --num_threads 2 --activation_function relu
    - coverage run -a --source . run_application.py inference -c config/vnet_config.txt --batch_size 16 --image_size 64 --label_size 64 --queue_length 32 --activation_function relu

    # need a large GPU to run
    #- coverage run -a --source . run_application.py train -c config/unet_config.txt --batch_size 1 --image_size 96 --label_size 96 --queue_length 5 --num_threads 2
    #- coverage run -a --source . run_application.py inference -c config/unet_config.txt --batch_size 1 --image_size 96 --label_size 96 --queue_length 5

    #- coverage run -a --source . run_application.py train -c config/deepmedic_config.txt --batch_size 8 --queue_length 16 --num_threads 2
    #- coverage run -a --source . run_application.py inference -c config/deepmedic_config.txt --batch_size 64 --queue_length 96

    - coverage run -a --source . run_application.py train -c config/default_config.txt --image_size 42 --label_size 42 --batch_size 3 --queue_length 6
    - coverage run -a --source . run_application.py inference -c config/default_config.txt --image_size 84 --label_size 84 --batch_size 7 --queue_length 14

    - coverage run -a --source . run_application.py train -c config/default_multimodal_config.txt --image_size 42 --label_size 42 --batch_size 3
    - coverage run -a --source . run_application.py inference -c config/default_multimodal_config.txt --image_size 84 --label_size 84 --batch_size 7

    - coverage run -a --source . -m testing.mean_variance_normalisation_test
    - coverage run -a --source . -m testing.binary_masking_test
    - coverage run -a --source . -m testing.histogram_normalisation_test
    - coverage run -a --source . -m testing.activation_test
    - coverage run -a --source . -m testing.bn_test
    - coverage run -a --source . -m testing.convolution_test
    - coverage run -a --source . -m testing.deconvolution_test
    - coverage run -a --source . -m testing.downsample_test
    - coverage run -a --source . -m testing.elementwise_test
    - coverage run -a --source . -m testing.highres3dnet_test
    - coverage run -a --source . -m testing.highresblock_test
    - coverage run -a --source . -m testing.upsample_test
    - coverage run -a --source . -m testing.toynet_test
    - coverage run -a --source . -m testing.crop_test
    - coverage run -a --source . -m testing.deepmedic_test
    - coverage run -a --source . -m testing.vnetblock_test
    - coverage run -a --source . -m testing.vnet_test
    - coverage run -a --source . -m testing.unetblock_test
      #- coverage run -a --source . -m testing.unet_test
    - coverage run -a --source . -m testing.scaleblock_test
    - coverage run -a --source . -m testing.scalenet_test
    - coverage run -a --source . -m testing.toy_sampler_test
    - coverage run -a --source . -m testing.input_buffer_test
    - coverage run -a --source . -m testing.dilatedcontext_test
    - coverage run -a --source . -m testing.loss_test
    - coverage run -a --source . -m testing.subject_test
    - coverage run -a --source . -m testing.volume_loader_test
    - coverage run -a --source . -m testing.uniform_sampler_test
    - coverage run -a --source . -m testing.grid_sampler_test
    - coverage run -a --source . -m testing.selective_sampler_test
    - coverage run -a --source . -m testing.rand_rotation_test
    - coverage run -a --source . -m testing.rand_spatial_scaling_test
    - coverage run -a --source . -m testing.post_processing_test
    - coverage run -a --source . -m testing.spatial_transformer_test
    - coverage run -a --source . -m testing.flip_test
    - coverage report -m
    - echo 'finished test'
  tags:
    - gift-linux

pip-installer:
  only:
    - 69-push-to-pip-repository-after-commit-to-master-off-dev
  script:
    # create a virtual env to test pip installer
    - venv="niftynet-pip-installer-venv"
    - virtualenv $venv
    # save NiftyNet folder path just in case
    - niftynet_dir=$(pwd)
    - cd $venv
    - source bin/activate
    # install using setup.py in NiftyNet folder
    - pip install $niftynet_dir
    # using already downloaded data instead of downloading it every time
    - ln -s /home/gitlab-runner/environments/niftynet/data/example_volumes ./example_volumes
    - ln -s /home/gitlab-runner/environments/niftynet/data/testing_data ./testing_data
    # start the tests
    - python -m niftynet.testing.mean_variance_normalisation_test
    - python -m niftynet.testing.binary_masking_test
    - python -m niftynet.testing.histogram_normalisation_test
    - python -m niftynet.testing.volume_loader_test
    - python -m niftynet.testing.activation_test
    - python -m niftynet.testing.spatial_transformer_test
    - python -m niftynet.testing.post_processing_test
    - python -m niftynet.testing.bn_test
    - python -m niftynet.testing.convolution_test
    - python -m niftynet.testing.crop_test
    - python -m niftynet.testing.deconvolution_test
    - python -m niftynet.testing.deepmedic_test
    - python -m niftynet.testing.dilatedcontext_test
    - python -m niftynet.testing.downsample_test
    - python -m niftynet.testing.elementwise_test
    - python -m niftynet.testing.grid_sampler_test
    - python -m niftynet.testing.highres3dnet_test
    - python -m niftynet.testing.highresblock_test
    - python -m niftynet.testing.input_buffer_test
    - python -m niftynet.testing.loss_test
    - python -m niftynet.testing.rand_rotation_test
    - python -m niftynet.testing.rand_spatial_scaling_test
    - python -m niftynet.testing.scaleblock_test
    - python -m niftynet.testing.scalenet_test
    - python -m niftynet.testing.selective_sampler_test
    - python -m niftynet.testing.subject_test
    - python -m niftynet.testing.test_sample
    - python -m niftynet.testing.toy_sampler_test
    - python -m niftynet.testing.toynet_test
    #python -m niftynet.testing.unet_test
    - python -m niftynet.testing.unetblock_test
    - python -m niftynet.testing.uniform_sampler_test
    - python -m niftynet.testing.upsample_test
    - python -m niftynet.testing.vnet_test
    - python -m niftynet.testing.vnetblock_test
    # deactivate virtual environment
    - deactivate
  tags:
    - gift-adelie
